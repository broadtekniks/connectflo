generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters", "postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  extensions = [vector]
}

model User {
  id                    String         @id @default(uuid())
  email                 String         @unique
  password              String?
  name                  String
  avatar                String?
  role                  Role           @default(CUSTOMER)
  tenantId              String?
  phoneNumber           String?        // Customer's phone number for SMS/calls
  isCheckedIn           Boolean        @default(false)
  checkedInAt           DateTime?
  forwardingPhoneNumber String?
  callerIdPhoneNumberId String?
  timeZone              String?
  agentTimeZone         String?        // Agent's timezone for scheduling
  workingHours          Json?          // Agent's working hours
  googleId              String?        @unique // Google OAuth ID for SSO
  emailVerified         Boolean        @default(false) // Email verification status
  emailVerificationToken String?      @unique // Token for email verification
  verificationTokenExpiry DateTime?   // Expiry time for verification token
  phoneVerified         Boolean        @default(false) // Phone verification status (Level 2)
  phoneVerificationCode String?       // SMS OTP code for phone verification
  phoneVerificationExpiry DateTime?   // Expiry time for phone verification code
  mfaEnabled            Boolean        @default(false) // TOTP MFA enabled status (Level 3)
  mfaSecret             String?        // TOTP secret key (encrypted)
  mfaBackupCodes        String[]       @default([]) // One-time backup codes
  extension             String?        @db.VarChar(10) // Extension number (e.g., "101", "5432")
  extensionEnabled      Boolean        @default(true) // Allow others to dial this extension
  extensionLabel        String?        @db.VarChar(100) // Display label for extension
  webPhoneStatus        WebPhoneStatus @default(OFFLINE) // Web phone presence status
  webPhoneLastSeen      DateTime?      // Last time web phone was online
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  assignedConversations Conversation[] @relation("AssignedAgent")
  conversations         Conversation[] @relation("Customer")
  conversationReads     ConversationRead[]
  assignedPhoneNumbers  PhoneNumber[]  @relation("AssignedUser")
  afterHoursPhoneNumbers PhoneNumber[] @relation("AfterHoursNotifyUser")
  callerIdPhoneNumber   PhoneNumber?   @relation("CallerIdPhoneNumber", fields: [callerIdPhoneNumberId], references: [id])
  tenant                Tenant?        @relation(fields: [tenantId], references: [id])
  leadCaptures          LeadCapture[]  @relation("LeadCustomer")
  callLogs              CallLog[]      @relation("CallCustomer")
  appointmentLogs       AppointmentLog[] @relation("AppointmentCustomer")
  feedbackLogs          FeedbackLog[]  @relation("FeedbackCustomer")
  assignedWorkflows     Workflow[]     @relation("AssignedAgent")

  callGroupMemberships  CallGroupMember[]

  @@unique([tenantId, extension])
  @@index([extension])
}

model Conversation {
  id           String             @id @default(uuid())
  channel      ChannelType
  status       ConversationStatus @default(OPEN)
  subject      String?
  priority     String             @default("MEDIUM")
  sentiment    Sentiment          @default(NEUTRAL)
  tags         String[]
  tenantId     String
  lastActivity DateTime           @default(now())
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  customerId   String
  assigneeId   String?
  tenant       Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  assignee     User?              @relation("AssignedAgent", fields: [assigneeId], references: [id])
  customer     User               @relation("Customer", fields: [customerId], references: [id])
  messages     Message[]
  reads        ConversationRead[]
  usageRecords UsageRecord[]

  @@index([tenantId])
}

model Message {
  id             String        @id @default(uuid())
  content        String
  sender         MessageSender
  isPrivateNote  Boolean       @default(false)
  attachments    String[]
  tenantId        String
  createdAt      DateTime      @default(now())
  conversationId String
  tenant         Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  conversation   Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([tenantId, createdAt])
  @@index([conversationId])
}

model ConversationRead {
  id             String   @id @default(uuid())
  tenantId       String
  conversationId String
  userId         String
  readAt         DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([tenantId])
  @@index([userId])
  @@index([conversationId])
}

model Document {
  id        String             @id @default(uuid())
  name      String
  type      String
  size      Int
  url       String
  status    String             @default("PENDING")
  tenantId  String
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt
  tenant    Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  chunks    DocumentChunk[]
  workflows WorkflowDocument[]

  @@index([tenantId])
}

model DocumentChunk {
  id            String   @id @default(uuid())
  content       String
  embeddingJson Json?
  documentId    String
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  document      Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([documentId])
}

model Integration {
  id           String                @id @default(uuid())
  name         String
  provider     String // 'google', 'shopify', 'stripe', etc.
  type         String // 'calendar', 'gmail', 'drive', 'sheets', etc.
  icon         String?
  connected    Boolean               @default(false)
  description  String?
  category     String?
  config       Json? // Provider-specific configuration
  credentials  Json? // Encrypted OAuth tokens: { accessToken, refreshToken, expiresAt, scope }
  tenantId     String
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt
  tenant       Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  workflows    WorkflowIntegration[]

  @@unique([tenantId, provider, type], name: "tenantId_provider_type")
}

model Workflow {
  id                 String                @id @default(uuid())
  name               String
  description        String
  isActive           Boolean               @default(false)
  triggerType        String
  runs               Int                   @default(0)
  lastRun            DateTime?
  nodes              Json
  edges              Json
  tenantId           String
  assignedAgentId    String?               // Assigned agent for this workflow (null = any agent)
  businessTimeZone   String?
  businessHours      Json?
  afterHoursMode     String?
  afterHoursMessage  String?
  afterHoursWorkflowId String?
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  aiConfigId         String?
  phoneVoiceId       String?
  phoneVoiceLanguage String?
  toneOfVoice        String?
  tenant             Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  aiConfig           AiConfig?             @relation(fields: [aiConfigId], references: [id])
  assignedAgent      User?                 @relation("AssignedAgent", fields: [assignedAgentId], references: [id])
  documents          WorkflowDocument[]
  integrations       WorkflowIntegration[]
  phoneNumbers       WorkflowPhoneNumber[]
  afterHoursPhoneNumbers PhoneNumber[] @relation("AfterHoursWorkflow")

  @@index([tenantId])
  @@index([assignedAgentId])
}

model PhoneNumber {
  id            String                @id @default(uuid())
  number        String                @unique
  friendlyName  String
  country       String
  region        String
  type          String
  capabilities  Json
  wholesaleCost Float
  retailPrice   Float
  setupCost     Float?
  pricingTierId String?
  monthlyCost   Float                 @default(0)
  status        String
  tenantId      String
  assignedToId  String?
  afterHoursMode         String?  @default("VOICEMAIL")
  afterHoursWorkflowId   String?
  afterHoursMessage      String?
  afterHoursNotifyUserId String?
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  provider      PhoneProvider         @default(TELNYX)
  tenant        Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  assignedTo    User?                 @relation("AssignedUser", fields: [assignedToId], references: [id])
  callerIdUsers User[]                @relation("CallerIdPhoneNumber")
  afterHoursWorkflow   Workflow? @relation("AfterHoursWorkflow", fields: [afterHoursWorkflowId], references: [id])
  afterHoursNotifyUser User?     @relation("AfterHoursNotifyUser", fields: [afterHoursNotifyUserId], references: [id])
  pricingTier   PricingTier?          @relation(fields: [pricingTierId], references: [id])
  usageRecords  UsageRecord[]
  workflows     WorkflowPhoneNumber[]
  callLogs      CallLog[]             @relation("CallPhoneNumber")

  @@index([tenantId])
}

model Tenant {
  id                 String    @id @default(uuid())
  name               String
  slug               String    @unique
  plan               String    @default("STARTER")
  status             String    @default("ACTIVE")
  businessTimeZone      String?
  businessHours         Json?
  webPhoneEnabled        Boolean   @default(false)
  webPhoneOutboundCallerNumber String?
  webPhoneOutboundCallerName   String?
  restrictExternalForwarding Boolean @default(false)
  externalForwardingAllowList String[] @default([])
  calendarAutoAddMeet   Boolean   @default(true)
  maxMeetingDurationMinutes Int @default(60)
  chatAfterHoursMode    String? @default("ONLY_ON_ESCALATION")
  chatAfterHoursMessage String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  phoneVoiceId       String?
  phoneVoiceLanguage String?
  aiConfig           AiConfig?
  users              User[]
  conversations       Conversation[]
  documents           Document[]
  documentChunks      DocumentChunk[]
  messages            Message[]
  conversationReads   ConversationRead[]
  integrations        Integration[]
  workflows           Workflow[]
  workflowDocuments   WorkflowDocument[]
  workflowIntegrations WorkflowIntegration[]
  workflowPhoneNumbers WorkflowPhoneNumber[]
  phoneNumbers        PhoneNumber[]
  usageRecords        UsageRecord[]
  leadCaptures        LeadCapture[]
  callLogs            CallLog[]
  appointmentLogs     AppointmentLog[]
  feedbackLogs        FeedbackLog[]
  smsOptOuts          SmsOptOut[]

  callGroups          CallGroup[]
}

model CallGroup {
  id                String   @id @default(uuid())
  tenantId          String
  name              String
  ringStrategy      String   @default("SEQUENTIAL") // SEQUENTIAL | SIMULTANEOUS
  ringTimeoutSeconds Int     @default(20)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  members           CallGroupMember[]

  @@index([tenantId])
  @@unique([tenantId, name])
}

model SmsOptOut {
  id          String   @id @default(uuid())
  tenantId    String
  phoneNumber String
  reason      String?
  optedOutAt  DateTime @default(now())

  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, phoneNumber])
  @@index([tenantId])
  @@index([phoneNumber])
}

model CallGroupMember {
  id          String   @id @default(uuid())
  tenantId    String
  callGroupId String
  userId      String
  order       Int      @default(0)
  createdAt   DateTime @default(now())

  callGroup   CallGroup @relation(fields: [callGroupId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([callGroupId])
  @@unique([callGroupId, userId])
}

model Plan {
  id                         String   @id @default(uuid())
  name                       String   @unique
  documentLimit              Int      @default(5)
  docSizeLimitMB             Int      @default(10)
  pricingDiscount            Float    @default(0.0)
  fallbackMarkup             Float    @default(0.50)
  createdAt                  DateTime @default(now())
  updatedAt                  DateTime @updatedAt
  maxDocumentsPerWorkflow    Int      @default(10)
  maxIntegrationsPerWorkflow Int      @default(3)
  maxPhoneNumbersPerWorkflow Int      @default(2)
  maxWorkflows               Int      @default(10)
}

model PricingTier {
  id           String        @id @default(uuid())
  name         String
  description  String?
  wholesaleMin Float
  wholesaleMax Float
  retailPrice  Float
  priority     Int           @default(0)
  isActive     Boolean       @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  phoneNumbers PhoneNumber[]
}

model AiConfig {
  id                  String     @id @default(uuid())
  tenantId            String     @unique
  name                String     @default("Flo")
  toneOfVoice         String     @default("Friendly & Casual")
  businessDescription String?
  systemPrompt        String     @default("You are Flo, a helpful assistant.")
  voiceId             String     @default("alloy")
  speakingRate        Float      @default(1.0)
  handoffThreshold    Float      @default(0.7)
  autoEscalate        Boolean    @default(true)
  intents             Json?      // Array of intent objects: [{ id, name, description, keywords, actions }]
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt
  tenant              Tenant     @relation(fields: [tenantId], references: [id])
  workflows           Workflow[]
}

model UsageRecord {
  id              String        @id @default(uuid())
  tenantId        String
  userId          String?
  type            UsageType
  phoneNumberId   String?
  callSid         String?
  durationSeconds Int?
  model           String?
  inputTokens     Int?
  outputTokens    Int?
  totalTokens     Int?
  messageCount    Int?
  messageId       String?
  wholesaleCost   Float
  retailCost      Float
  markup          Float
  conversationId  String?
  metadata        Json?
  createdAt       DateTime      @default(now())
  tenant          Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  conversation    Conversation? @relation(fields: [conversationId], references: [id])
  phoneNumber     PhoneNumber?  @relation(fields: [phoneNumberId], references: [id])

  @@index([tenantId, createdAt])
  @@index([userId, createdAt])
  @@index([type, createdAt])
  @@index([conversationId])
}

model WorkflowPhoneNumber {
  id            String      @id @default(uuid())
  workflowId    String
  phoneNumberId String
  tenantId      String
  createdAt     DateTime    @default(now())
  tenant        Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  phoneNumber   PhoneNumber @relation(fields: [phoneNumberId], references: [id], onDelete: Cascade)
  workflow      Workflow    @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@unique([workflowId, phoneNumberId])
  @@index([tenantId])
  @@index([workflowId])
  @@index([phoneNumberId])
}

model WorkflowDocument {
  id         String   @id @default(uuid())
  workflowId String
  documentId String
  tenantId   String
  createdAt  DateTime @default(now())
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  workflow   Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@unique([workflowId, documentId])
  @@index([tenantId])
  @@index([workflowId])
  @@index([documentId])
}

model WorkflowIntegration {
  id            String      @id @default(uuid())
  workflowId    String
  integrationId String
  tenantId      String
  createdAt     DateTime    @default(now())
  tenant        Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  integration   Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  workflow      Workflow    @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@unique([workflowId, integrationId])
  @@index([tenantId])
  @@index([workflowId])
  @@index([integrationId])
}

enum Role {
  SUPER_ADMIN
  TENANT_ADMIN
  AGENT
  CUSTOMER
}

enum ChannelType {
  CHAT
  EMAIL
  VOICE
  SMS
}

enum ConversationStatus {
  OPEN
  PENDING
  RESOLVED
}

enum MessageSender {
  CUSTOMER
  AGENT
  AI
  SYSTEM
}

enum Sentiment {
  POSITIVE
  NEUTRAL
  NEGATIVE
}

enum UsageType {
  VOICE_INBOUND
  VOICE_OUTBOUND
  SMS_INBOUND
  SMS_OUTBOUND
  MMS_INBOUND
  MMS_OUTBOUND
  AI_TOKENS_INPUT
  AI_TOKENS_OUTPUT
  AI_EMBEDDING
  STORAGE_GB
}

enum PhoneProvider {
  TELNYX
  TWILIO
}

model LeadCapture {
  id              String   @id @default(uuid())
  tenantId        String
  customerId      String?
  name            String?
  email           String?
  phone           String?
  source          String?
  status          String   @default("NEW")
  notes           String?
  metadata        Json?
  conversationId  String?
  spreadsheetId   String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer        User?    @relation("LeadCustomer", fields: [customerId], references: [id])

  @@index([tenantId, createdAt])
  @@index([customerId])
  @@index([status])
}

model CallLog {
  id                String       @id @default(uuid())
  tenantId          String
  customerId        String?
  phoneNumberId     String?
  callSid           String?      @unique
  direction         String
  from              String
  to                String
  status            String
  durationSeconds   Int          @default(0)
  recordingUrl      String?
  transcriptSummary String?
  sentiment         String?      @default("NEUTRAL")
  outcome           String?
  metadata          Json?
  conversationId    String?
  fromExtension     String?      @db.VarChar(10)
  toExtension       String?      @db.VarChar(10)
  fromUserId        String?
  toUserId          String?
  callType          CallType     @default(EXTERNAL)
  cost              Float        @default(0)
  endedAt           DateTime?
  createdAt         DateTime     @default(now())
  tenant            Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer          User?        @relation("CallCustomer", fields: [customerId], references: [id])
  phoneNumber       PhoneNumber? @relation("CallPhoneNumber", fields: [phoneNumberId], references: [id])

  @@index([tenantId, createdAt])
  @@index([customerId])
  @@index([callSid])
  @@index([phoneNumberId])
  @@index([fromExtension])
  @@index([toExtension])
  @@index([fromUserId])
  @@index([toUserId])
}

model AppointmentLog {
  id              String   @id @default(uuid())
  tenantId        String
  customerId      String?
  customerName    String?
  customerEmail   String?
  customerPhone   String?
  appointmentTime DateTime
  durationMinutes Int
  status          String   @default("SCHEDULED")
  eventId         String?
  source          String?
  notes           String?
  metadata        Json?
  conversationId  String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer        User?    @relation("AppointmentCustomer", fields: [customerId], references: [id])

  @@index([tenantId, appointmentTime])
  @@index([customerId])
  @@index([status])
}

model FeedbackLog {
  id             String   @id @default(uuid())
  tenantId       String
  customerId     String?
  conversationId String?
  rating         Int?
  sentiment      String?  @default("NEUTRAL")
  category       String?
  feedback       String?
  source         String?
  metadata       Json?
  createdAt      DateTime @default(now())
  tenant         Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer       User?    @relation("FeedbackCustomer", fields: [customerId], references: [id])

  @@index([tenantId, createdAt])
  @@index([customerId])
  @@index([rating])
}

enum WebPhoneStatus {
  ONLINE
  BUSY
  AWAY
  OFFLINE
}

enum CallType {
  EXTERNAL
  INTERNAL_VOIP
  INTERNAL_PSTN
}
